version: '3'

services:

  api:
    build: ./services/api
    environment:
      - RESIDENTIAL_PROXY=${RESIDENTIAL_PROXY}
      - FLASK_AUTH_TOKEN=${FLASK_AUTH_TOKEN}

    ports:
      - ${API_PORT}:5000
    
  

  numberplate-prediction:
    build:
      context: ./services/machine-learning/numberplate-prediction
      dockerfile: Dockerfile.image

    # volumes:
    #   - /var/www/html/files:/usr/src/app/files

    volumes:
      - ./media:/usr/src/app/media
    
    environment:
      PLATE_RECOGNIZER_TOKEN : ${PLATE_RECOGNIZER_TOKEN}
    
    deploy:
      mode: replicated
      replicas: 2
      resources:
        limits:
          cpus: '5'


  redis:
    image: "redis:alpine"
    hostname: redis
    volumes:
      - ./services/redis/data:/data

  mongodb:
    image: mongo:latest
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_USERNAME}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_PASSWORD}

    ports:
      - ${MONGO_PORT}:27017
    volumes:
      - .services/mongodb/database:/data/db
    restart: on-failure

  listing-scraper:
    build:
      context: ./services/scrapers/autotrader
      dockerfile: Dockerfile.listing

    depends_on:
      - pulsar
    
    environment:
      - RESIDENTIAL_PROXY=${RESIDENTIAL_PROXY}
      - DATACENTER_PROXY=${DATACENTER_PROXY}
    deploy:
      mode: replicated
      replicas: 64
    
    stdin_open: true
  
  validator:
    build:
      context: ./services/scrapers/autotrader
      dockerfile: Dockerfile.validator

    depends_on:
      - pulsar
    
    environment:
      - RESIDENTIAL_PROXY=${RESIDENTIAL_PROXY}
      - MYSQL_HOST=${MYSQL_HOST}
      - MYSQL_USERNAME=${MYSQL_USERNAME}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD}
      - MYSQL_DATABASE=${MYSQL_DATABASE}
    
    stdin_open: true
  

  init-dealer-scraper:
    build:
      context: ./services/scrapers/autotrader
      dockerfile: Dockerfile.initDealerScraper

    depends_on:
      - pulsar
    
    environment:
      - RESIDENTIAL_PROXY=${RESIDENTIAL_PROXY}
      - MYSQL_HOST=${MYSQL_HOST}
      - MYSQL_USERNAME=${MYSQL_USERNAME}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD}
      - MYSQL_DATABASE=${MYSQL_DATABASE}
    
    stdin_open: true
  
  dealer-listing-validator:
    build:
      context: ./services/scrapers/autotrader
      dockerfile: Dockerfile.dealer.validator

    depends_on:
      - pulsar
    
    environment:
      - RESIDENTIAL_PROXY=${RESIDENTIAL_PROXY}
      - MYSQL_HOST=${MYSQL_HOST}
      - MYSQL_USERNAME=${MYSQL_USERNAME}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD}
      - MYSQL_DATABASE=${MYSQL_DATABASE}
    
    stdin_open: true
  
  dealer-scrapy-listing-validator:
    build:
      context: ./services/scrapers/autotrader/spiders
      dockerfile: Dockerfile.dealer.scrapy.validator

    depends_on:
      - pulsar
    
    environment:
      - RESIDENTIAL_PROXY=${RESIDENTIAL_PROXY}
      - MYSQL_HOST=${MYSQL_HOST}
      - MYSQL_USERNAME=${MYSQL_USERNAME}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD}
      - MYSQL_DATABASE=${MYSQL_DATABASE}
    
    stdin_open: true
  
  url-scraper:
    build:
      context: ./services/scrapers/autotrader
      dockerfile: Dockerfile.url

    depends_on:
      - pulsar
    
    environment:
      - RESIDENTIAL_PROXY=${RESIDENTIAL_PROXY}
      - MYSQL_HOST=${MYSQL_HOST}
      - MYSQL_USERNAME=${MYSQL_USERNAME}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD}
      - MYSQL_DATABASE=${MYSQL_DATABASE}

    stdin_open: true
  

  ftp-scraper:
    build:
      context: ./services/scrapers/ftp-scraper
      dockerfile: Dockerfile.ftp

    depends_on:
      - pulsar
    
    volumes:
      - ./services/ftp/files:/files
      - ./services/ftp/processed-files:/processed-files

    stdin_open: true
  
  dealer-scraper:
    build:
      context: ./services/scrapers/autotrader
      dockerfile: Dockerfile.dealer

    depends_on:
      - pulsar
    
    environment:
      - RESIDENTIAL_PROXY=${RESIDENTIAL_PROXY}
    
    deploy:
      mode: replicated
      replicas: 5
    
    stdin_open: true
  
  makemodel-prediction:
    build:
      context: ./services/machine-learning/make-model
      dockerfile: Dockerfile.makemodel
    
    restart: on-failure

    deploy:
      mode: replicated
      replicas: 2

  pulsar:
    build: ./services/pulsar
    volumes:
      - ./services/pulsar/pulsardata:/pulsar/data
    
    command: "bin/pulsar standalone"

    restart: on-failure
  
  # pulsar-dashboard:
  #   image: apachepulsar/pulsar-manager:v0.2.0
  #   ports:
  #     - "9527:9527"
  #     - "7750:7750"
  #   depends_on:
  #     - pulsar
  #   links:
  #     - pulsar
  #   environment:
  #     SPRING_CONFIGURATION_FILE: /pulsar-manager/pulsar-manager/application.properties
  
  # cadvisor:
  #   image: gcr.io/cadvisor/cadvisor:latest
  #   container_name: cadvisor
  #   ports:
  #   - 8788:8080
  #   volumes:
  #   - /:/rootfs:ro
  #   - /var/run:/var/run:rw
  #   - /sys:/sys:ro
  #   - /var/lib/docker/:/var/lib/docker:ro
  #   depends_on:
  #   - redis

  transform:
    build: ./services/transform

    restart: on-failure

    deploy:
      mode: replicated
      replicas: 20
  
  post-calculation:
    build: ./services/postCalculation

    environment:
      - MYSQL_HOST=${MYSQL_HOST}
      - MYSQL_USERNAME=${MYSQL_USERNAME}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD}
      - MYSQL_DATABASE=${MYSQL_DATABASE}

    restart: on-failure

    deploy:
      mode: replicated
      replicas: 6
  
  logs:
    build: ./services/logs

    environment:
      - MONGO_USERNAME=${MONGO_USERNAME}
      - MONGO_PASSWORD=${MONGO_PASSWORD}

    restart: on-failure

  
  seat-prediction:
    build:
      context: ./services/machine-learning/seats
      dockerfile: Dockerfile.seats

    restart: on-failure

    deploy:
      replicas: 1
  
  pre-validation:
    build: ./services/pre-validation

    environment:
      - MYSQL_HOST=${MYSQL_HOST}
      - MYSQL_USERNAME=${MYSQL_USERNAME}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD}
      - MYSQL_DATABASE=${MYSQL_DATABASE}

    restart: on-failure

    deploy:
      mode: replicated
      replicas: 20
  
  post-validation:
    build: ./services/post-validation

    environment:
      - MYSQL_HOST=${MYSQL_HOST}
      - MYSQL_USERNAME=${MYSQL_USERNAME}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD}
      - MYSQL_DATABASE=${MYSQL_DATABASE}

    restart: on-failure

    

  image-prediction:
    build:
      context: ./services/machine-learning/image
      dockerfile: Dockerfile.image

    restart: on-failure

    volumes:
      - ./media:/usr/src/app/media

    deploy:
      mode: replicated
      replicas: 2
      resources:
        limits:
          cpus: '5'
    
    environment:
      - DATACENTER_PROXY=${DATACENTER_PROXY}


  image-generation:
    build: 
      context: ./services/imageGenerator
      dockerfile: Dockerfile.image

    restart: on-failure
    
    environment:
      PRODUCTION_SERVER_FTP_USERNAME: ${PRODUCTION_SERVER_FTP_USERNAME}
      PRODUCTION_SERVER_FTP_PASSWORD : ${PRODUCTION_SERVER_FTP_PASSWORD}
      PRODUCTION_SERVER_IMAGE_DIR_PREFIX : ${PRODUCTION_SERVER_IMAGE_DIR_PREFIX}
      PRODUCTION_SERVER_FTP_PORT : ${PRODUCTION_SERVER_FTP_PORT}
      PRODUCTION_SERVER_IP_ADDRESS : ${PRODUCTION_SERVER_IP_ADDRESS}
    
    volumes:
      - ./media:/usr/src/app/media
    
    stdin_open: true
    tty: true

    deploy:
      mode: replicated
      replicas: 1
      resources:
        limits:
          cpus: '2'

  # db:
  #   image: mysql:latest
  #   container_name: db
  #   environment:
  #     MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
  #     MYSQL_DATABASE: ${MYSQL_DATABASE}
  #     MYSQL_USER: ${MYSQL_USERNAME}
  #     MYSQL_PASSWORD: ${MYSQL_PASSWORD}
  #   ports:
  #     - "6034:3306"
  #   volumes:
  #     - ./services/mysql/data:/var/lib/mysql
    
  #   cap_add:
  #     - SYS_NICE

  # phpmyadmin:
  #   image: phpmyadmin/phpmyadmin:latest
  #   container_name: pma
  #   links:
  #     - db
  #   environment:
  #     PMA_HOST: db
  #     PMA_PORT: 3306
  #     PMA_ARBITRARY: 0
  #   restart: always
  #   ports:
  #     - 8090:80
  
  ftps:
    image: bfren/ftps

    restart: on-failure

    volumes:
      - ./services/ftp/files:/files
      - ./services/ftp/ssl:/ssl
    
    ports:
      - "${FTPS_PORT}:21"
      - "5026:990"
      - "18700-18710:18700-18710"
    
    environment:
      - FTPS_USER=${FTPS_USERNAME}
      - FTPS_PASS=${FTPS_PASSWORD}
      - FTPS_EXTERNAL_URI=${FTPS_IP}
  
  # local-db-handler:
  #   build:
  #     context: ./services/database/local
  #     dockerfile : Dockerfile.local
    
  #   restart: on-failure
    
  #   environment:
  #     - MONGO_USERNAME=${MONGO_USERNAME}
  #     - MONGO_PASSWORD=${MONGO_PASSWORD}
  
  production-db-fllistings:
    build:
      context: ./services/database/production
      dockerfile : Dockerfile.flListings
    
    restart: on-failure

    environment:
      - MONGO_USERNAME=${MONGO_USERNAME}
      - MONGO_PASSWORD=${MONGO_PASSWORD}
      - MYSQL_HOST=${MYSQL_HOST}
      - MYSQL_USERNAME=${MYSQL_USERNAME}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD}
      - MYSQL_DATABASE=${MYSQL_DATABASE}
    
    deploy:
      mode: replicated
      replicas: 5

  
  production-db-aturls:
    build:
      context: ./services/database/production
      dockerfile : Dockerfile.aturls
    
    restart: on-failure

    environment:
      - MONGO_USERNAME=${MONGO_USERNAME}
      - MONGO_PASSWORD=${MONGO_PASSWORD}
      - MYSQL_HOST=${MYSQL_HOST}
      - MYSQL_USERNAME=${MYSQL_USERNAME}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD}
      - MYSQL_DATABASE=${MYSQL_DATABASE}
    
  
  production-db-fllistingphotos:
    build:
      context: ./services/database/production
      dockerfile : Dockerfile.flListingPhotos
    
    restart: on-failure

    environment:
      - MONGO_USERNAME=${MONGO_USERNAME}
      - MONGO_PASSWORD=${MONGO_PASSWORD}
      - MYSQL_HOST=${MYSQL_HOST}
      - MYSQL_USERNAME=${MYSQL_USERNAME}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD}
      - MYSQL_DATABASE=${MYSQL_DATABASE}
  
  production-db-fllistings-finder:
    build:
      context: ./services/database/production
      dockerfile : Dockerfile.flListings.finder
    
    restart: on-failure

    environment:
      - MONGO_USERNAME=${MONGO_USERNAME}
      - MONGO_PASSWORD=${MONGO_PASSWORD}
      - MYSQL_HOST=${MYSQL_HOST}
      - MYSQL_USERNAME=${MYSQL_USERNAME}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD}
      - MYSQL_DATABASE=${MYSQL_DATABASE}
    
    deploy:
      mode: replicated
      replicas: 20
    
    # networks:
    #   outside:
    #     external: true